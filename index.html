<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ForestApp Pro - Rilevamento Forestale</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Applicazione PWA per rilevamenti forestali professionali con aree di saggio e piedilista">
    <meta name="theme-color" content="#16a34a">
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ForestApp Pro">
    <link rel="apple-touch-icon" href="assets/icons/icon-192x192.png">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/icons/icon-16x16.png">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="app-container">
        <!-- Configuration Alert -->
        <div class="config-alert" id="configAlert" style="display: none;">
            <h3>‚ö†Ô∏è CONFIGURAZIONE RICHIESTA</h3>
            <p>Prima di usare l'app, devi sostituire l'URL di Google Apps Script nel codice.</p>
            <p>Cerca questa riga: <code>const GOOGLE_APPS_SCRIPT_URL = 'IL_TUO_URL_QUI';</code></p>
            <p>E sostituiscila con il tuo URL vero di Google Apps Script.</p>
        </div>

        <!-- Header -->
        <header class="header">
            <div class="header-top">
                <div class="app-title">
                    <div class="app-icon">üå≤</div>
                    <div>
                        <h1>ForestApp Pro</h1>
                        <div class="subtitle">Con Aree di Saggio</div>
                    </div>
                </div>
                
                <div class="status-bar">
                    <div id="connectionStatus" class="status-item status-online">
                        <span id="statusIcon">üü¢</span>
                        <span id="statusText">Online</span>
                    </div>
                    <div class="status-item">
                        <span>üìÅ</span>
                        <select id="projectSelector" onchange="switchToProject(this.value)" style="background: transparent; border: none; color: inherit; font-weight: 500;">
                            <option value="">Caricamento progetti...</option>
                        </select>
                    </div>
                    <div class="status-item">
                        <span>üìç</span>
                        <span id="currentArea">Area 1</span>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalSampleTrees">0</div>
                    <div class="stat-label">Piante Saggio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalInventoryTrees">0</div>
                    <div class="stat-label">Piedilista</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="speciesWithHeights">0/5</div>
                    <div class="stat-label">Specie con Altezze</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalVolume">0.0 m¬≥</div>
                    <div class="stat-label">Volume Totale</div>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('sample-area')">
                <span>üìè</span>
                <span>Aree di Saggio</span>
            </button>
            <button class="tab-btn" onclick="switchTab('inventory')">
                <span>üìä</span>
                <span>Piedilista</span>
            </button>
            <button class="tab-btn" onclick="switchTab('results')">
                <span>üìà</span>
                <span>Risultati</span>
            </button>
        </div>

        <!-- Sample Area Tab -->
        <div id="sample-area" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        üìè Area di Saggio
                    </h2>
                </div>

                <!-- Area Selection -->
                <div class="area-selector">
                    <div class="area-input">
                        <label for="sampleAreaSelect">Area di Saggio:</label>
                        <select id="sampleAreaSelect" onchange="selectSampleArea(this.value)">
                            <option value="area1">Area 1</option>
                            <option value="area2">Area 2</option>
                            <option value="area3">Area 3</option>
                            <option value="area4">Area 4</option>
                            <option value="area5">Area 5</option>
                        </select>
                    </div>
                </div>

                <!-- Species Selection -->
                <div class="species-selector">
                    <div class="species-title">üå≤ Seleziona Specie per Rilevamento Altezze</div>
                    <div class="species-grid">
                        <button class="species-btn" data-species="pino-domestico" onclick="selectSpeciesForHeight('pino-domestico')">
                            <span class="species-icon">üå≤</span>
                            <div>Pino Domestico</div>
                        </button>
                        <button class="species-btn" data-species="pino-marittimo" onclick="selectSpeciesForHeight('pino-marittimo')">
                            <span class="species-icon">üå≤</span>
                            <div>Pino Marittimo</div>
                        </button>
                        <button class="species-btn" data-species="pino-aleppo" onclick="selectSpeciesForHeight('pino-aleppo')">
                            <span class="species-icon">üå≤</span>
                            <div>Pino d'Aleppo</div>
                        </button>
                        <button class="species-btn" data-species="cipresso" onclick="selectSpeciesForHeight('cipresso')">
                            <span class="species-icon">üå≤</span>
                            <div>Cipresso Comune</div>
                        </button>
                        <button class="species-btn" data-species="altro" onclick="selectSpeciesForHeight('altro')">
                            <span class="species-icon">‚ùì</span>
                            <div>Altro</div>
                        </button>
                    </div>
                </div>

                <!-- Diameter Classes for Sample -->
                <div class="diameter-classes">
                    <div class="diameter-row">
                        <div class="diameter-info">
                            <div class="diameter-label">Classe 5 cm</div>
                            <div class="diameter-range">Range: 2.5 - 7.5 cm</div>
                        </div>
                        <button class="add-tree-btn" onclick="addSampleTree(5)" disabled>
                            <span>‚ûï</span>
                            <span>Pianta Saggio</span>
                        </button>
                    </div>
                    
                    <div class="diameter-row">
                        <div class="diameter-info">
                            <div class="diameter-label">Classe 10 cm</div>
                            <div class="diameter-range">Range: 7.6 - 12.5 cm</div>
                        </div>
                        <button class="add-tree-btn" onclick="addSampleTree(10)" disabled>
                            <span>‚ûï</span>
                            <span>Pianta Saggio</span>
                        </button>
                    </div>
                    
                    <div class="diameter-row">
                        <div class="diameter-info">
                            <div class="diameter-label">Classe 15 cm</div>
                            <div class="diameter-range">Range: 12.6 - 17.5 cm</div>
                        </div>
                        <button class="add-tree-btn" onclick="addSampleTree(15)" disabled>
                            <span>‚ûï</span>
                            <span>Pianta Saggio</span>
                        </button>
                    </div>
                    
                    <div class="diameter-row">
                        <div class="diameter-info">
                            <div class="diameter-label">Classe 20 cm</div>
                            <div class="diameter-range">Range: 17.6 - 22.5 cm</div>
                        </div>
                        <button class="add-tree-btn" onclick="addSampleTree(20)" disabled>
                            <span>‚ûï</span>
                            <span>Pianta Saggio</span>
                        </button>
                    </div>
                    
                    <div class="diameter-row">
                        <div class="diameter-info">
                            <div class="diameter-label">Classe 25 cm</div>
                            <div class="diameter-range">Range: 22.6 - 27.5 cm</div>
                        </div>
                        <button class="add-tree-btn" onclick="addSampleTree(25)" disabled>
                            <span>‚ûï</span>
                            <span>Pianta Saggio</span>
                        </button>
                    </div>
                    
                    <div class="diameter-row">
                        <div class="diameter-info">
                            <div class="diameter-label">Classe 30 cm</div>
                            <div class="diameter-range">Range: 27.6 - 32.5 cm</div>
                        </div>
                        <button class="add-tree-btn" onclick="addSampleTree(30)" disabled>
                            <span>‚ûï</span>
                            <span>Pianta Saggio</span>
                        </button>
                    </div>
                    
                    <div class="diameter-row">
                        <div class="diameter-info">
                            <div class="diameter-label">Classe 35 cm</div>
                            <div class="diameter-range">Range: 32.6 - 37.5 cm</div>
                        </div>
                        <button class="add-tree-btn" onclick="addSampleTree(35)" disabled>
                            <span>‚ûï</span>
                            <span>Pianta Saggio</span>
                        </button>
                    </div>
                    
                    <div class="diameter-row">
                        <div class="diameter-info">
                            <div class="diameter-label">Classe 40+ cm</div>
                            <div class="diameter-range">Range: > 37.5 cm</div>
                        </div>
                        <button class="add-tree-btn" onclick="addSampleTree(40)" disabled>
                            <span>‚ûï</span>
                            <span>Pianta Saggio</span>
                        </button>
                    </div>
                </div>

                <!-- Height Classes -->
                <div class="height-classes">
                    <h3>üìê Altezze (metri)</h3>
                    
                    <div class="height-row">
                        <div class="height-info">
                            <div class="height-label">2-4 metri</div>
                            <div class="height-range">Range: 2.0 - 3.9 m</div>
                        </div>
                        <button class="add-height-btn" onclick="addHeightMeasurement(3)" disabled>
                            <span>üìè</span>
                            <span>Altezza 3m</span>
                        </button>
                    </div>

                    <div class="height-row">
                        <div class="height-info">
                            <div class="height-label">4-6 metri</div>
                            <div class="height-range">Range: 4.0 - 5.9 m</div>
                        </div>
                        <button class="add-height-btn" onclick="addHeightMeasurement(5)" disabled>
                            <span>üìè</span>
                            <span>Altezza 5m</span>
                        </button>
                    </div>

                    <div class="height-row">
                        <div class="height-info">
                            <div class="height-label">6-8 metri</div>
                            <div class="height-range">Range: 6.0 - 7.9 m</div>
                        </div>
                        <button class="add-height-btn" onclick="addHeightMeasurement(7)" disabled>
                            <span>üìè</span>
                            <span>Altezza 7m</span>
                        </button>
                    </div>

                    <div class="height-row">
                        <div class="height-info">
                            <div class="height-label">8-10 metri</div>
                            <div class="height-range">Range: 8.0 - 9.9 m</div>
                        </div>
                        <button class="add-height-btn" onclick="addHeightMeasurement(9)" disabled>
                            <span>üìè</span>
                            <span>Altezza 9m</span>
                        </button>
                    </div>

                    <div class="height-row">
                        <div class="height-info">
                            <div class="height-label">10-12 metri</div>
                            <div class="height-range">Range: 10.0 - 11.9 m</div>
                        </div>
                        <button class="add-height-btn" onclick="addHeightMeasurement(11)" disabled>
                            <span>üìè</span>
                            <span>Altezza 11m</span>
                        </button>
                    </div>

                    <div class="height-row">
                        <div class="height-info">
                            <div class="height-label">12-15 metri</div>
                            <div class="height-range">Range: 12.0 - 14.9 m</div>
                        </div>
                        <button class="add-height-btn" onclick="addHeightMeasurement(13.5)" disabled>
                            <span>üìè</span>
                            <span>Altezza 13.5m</span>
                        </button>
                    </div>

                    <div class="height-row">
                        <div class="height-info">
                            <div class="height-label">15-18 metri</div>
                            <div class="height-range">Range: 15.0 - 17.9 m</div>
                        </div>
                        <button class="add-height-btn" onclick="addHeightMeasurement(16.5)" disabled>
                            <span>üìè</span>
                            <span>Altezza 16.5m</span>
                        </button>
                    </div>

                    <div class="height-row">
                        <div class="height-info">
                            <div class="height-label">18-22 metri</div>
                            <div class="height-range">Range: 18.0 - 21.9 m</div>
                        </div>
                        <button class="add-height-btn" onclick="addHeightMeasurement(20)" disabled>
                            <span>üìè</span>
                            <span>Altezza 20m</span>
                        </button>
                    </div>

                    <div class="height-row">
                        <div class="height-info">
                            <div class="height-label">22+ metri</div>
                            <div class="height-range">Range: > 22.0 m</div>
                        </div>
                        <button class="add-height-btn" onclick="addHeightMeasurement(25)" disabled>
                            <span>üìè</span>
                            <span>Altezza 25m</span>
                        </button>
                    </div>
                </div>

                <!-- Height Averages Display -->
                <div class="height-averages" id="heightAverages">
                    <h4>üìä Altezze Medie Calcolate</h4>
                    <div id="averagesList">
                        <p style="text-align: center; color: var(--text-secondary);">Nessuna altezza rilevata ancora</p>
                    </div>
                </div>

                <!-- Recent Sample Trees -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            üìù Piante Saggio Recenti
                        </h2>
                        <span id="sampleTreeCount" class="stat-value" style="font-size: 1rem;">0 piante</span>
                    </div>
                    
                    <div class="recent-entries" id="recentSampleTrees">
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            Nessuna pianta di saggio rilevata ancora.<br>
                            Seleziona una specie e inizia i rilevamenti!
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        üìä Piedilista
                    </h2>
                    <button class="btn btn-secondary" onclick="clearInventoryData()">
                        üóëÔ∏è Pulisci Piedilista
                    </button>
                </div>

                <!-- Area Input -->
                <div class="area-selector">
                    <div class="area-input">
                        <label for="inventoryAreaHa">Area di riferimento (ha):</label>
                        <input type="number" id="inventoryAreaHa" step="0.1" min="0.1" max="1000" value="30.0" onchange="updateInventoryArea()">
                    </div>
                </div>

                <!-- Volume Warning -->
                <div class="volume-warning" id="volumeWarning" style="display: none;">
                    <h4>‚ö†Ô∏è Altezze Mancanti</h4>
                    <p>Alcune specie non hanno altezze medie dalle aree di saggio. I volumi non verranno calcolati fino a quando non avrai dati sufficienti o inserisci manualmente le altezze medie.</p>
                </div>

                <!-- Species Selection -->
                <div class="species-selector">
                    <div class="species-title">üå≤ Seleziona Specie per Piedilista</div>
                    <div class="species-grid">
                        <button class="species-btn" data-species="pino-domestico" onclick="selectSpeciesForInventory('pino-domestico')">
                            <span class="species-icon">üå≤</span>
                            <div>Pino Domestico</div>
                            <div id="height-status-pino-domestico" style="font-size: 0.7rem; margin-top: 0.25rem;"></div>
                        </button>
                        <button class="species-btn" data-species="pino-marittimo" onclick="selectSpeciesForInventory('pino-marittimo')">
                            <span class="species-icon">üå≤</span>
                            <div>Pino Marittimo</div>
                            <div id="height-status-pino-marittimo" style="font-size: 0.7rem; margin-top: 0.25rem;"></div>
                        </button>
                        <button class="species-btn" data-species="pino-aleppo" onclick="selectSpeciesForInventory('pino-aleppo')">
                            <span class="species-icon">üå≤</span>
                            <div>Pino d'Aleppo</div>
                            <div id="height-status-pino-aleppo" style="font-size: 0.7rem; margin-top: 0.25rem;"></div>
                        </button>
                        <button class="species-btn" data-species="cipresso" onclick="selectSpeciesForInventory('cipresso')">
                            <span class="species-icon">üå≤</span>
                            <div>Cipresso Comune</div>
                            <div id="height-status-cipresso" style="font-size: 0.7rem; margin-top: 0.25rem;"></div>
                        </button>
                        <button class="species-btn" data-species="altro" onclick="selectSpeciesForInventory('altro')">
                            <span class="species-icon">‚ùì</span>
                            <div>Altro</div>
                            <div id="height-status-altro" style="font-size: 0.7rem; margin-top: 0.25rem;"></div>
                        </button>
                    </div>
                </div>

                <!-- Diameter Classes for Inventory -->
                <div class="diameter-classes">
                    <div class="diameter-row">
                        <div class="diameter-info">
                            <div class="diameter-label">Classe 5 cm</div>
                            <div class="diameter-range">Range: 2.5 - 7.5 cm</div>
                        </div>
                        <button class="add-tree-btn" onclick="addInventoryTree(5)" disabled>
                            <span>‚ûï</span>
                            <span>Aggiungi Pianta</span>
                        </button>
                    </div>
                    
                    <div class="diameter-row">
                        <div class="diameter-info">
                            <div class="diameter-label">Classe 10 cm</div>
                            <div class="diameter-range">Range: 7.6 - 12.5 cm</div>
                        </div>
                        <button class="add-tree-btn" onclick="addInventoryTree(10)" disabled>
                            <span>‚ûï</span>
                            <span>Aggiungi Pianta</span>
                        </button>
                    </div>
                    
                    <div class="diameter-row">
                        <div class="diameter-info">
                            <div class="diameter-label">Classe 15 cm</div>
                            <div class="diameter-range">Range: 12.6 - 17.5 cm</div>
                        </div>
                        <button class="add-tree-btn" onclick="addInventoryTree(15)" disabled>
                            <span>‚ûï</span>
                            <span>Aggiungi Pianta</span>
                        </button>
                    </div>
                    
                    <div class="diameter-row">
                        <div class="diameter-info">
                            <div class="diameter-label">Classe 20 cm</div>
                            <div class="diameter-range">Range: 17.6 - 22.5 cm</div>
                        </div>
                        <button class="add-tree-btn" onclick="addInventoryTree(20)" disabled>
                            <span>‚ûï</span>
                            <span>Aggiungi Pianta</span>
                        </button>
                    </div>
                    
                    <div class="diameter-row">
                        <div class="diameter-info">
                            <div class="diameter-label">Classe 25 cm</div>
                            <div class="diameter-range">Range: 22.6 - 27.5 cm</div>
                        </div>
                        <button class="add-tree-btn" onclick="addInventoryTree(25)" disabled>
                            <span>‚ûï</span>
                            <span>Aggiungi Pianta</span>
                        </button>
                    </div>
                    
                    <div class="diameter-row">
                        <div class="diameter-info">
                            <div class="diameter-label">Classe 30 cm</div>
                            <div class="diameter-range">Range: 27.6 - 32.5 cm</div>
                        </div>
                        <button class="add-tree-btn" onclick="addInventoryTree(30)" disabled>
                            <span>‚ûï</span>
                            <span>Aggiungi Pianta</span>
                        </button>
                    </div>
                    
                    <div class="diameter-row">
                        <div class="diameter-info">
                            <div class="diameter-label">Classe 35 cm</div>
                            <div class="diameter-range">Range: 32.6 - 37.5 cm</div>
                        </div>
                        <button class="add-tree-btn" onclick="addInventoryTree(35)" disabled>
                            <span>‚ûï</span>
                            <span>Aggiungi Pianta</span>
                        </button>
                    </div>
                    
                    <div class="diameter-row">
                        <div class="diameter-info">
                            <div class="diameter-label">Classe 40+ cm</div>
                            <div class="diameter-range">Range: > 37.5 cm</div>
                        </div>
                        <button class="add-tree-btn" onclick="addInventoryTree(40)" disabled>
                            <span>‚ûï</span>
                            <span>Aggiungi Pianta</span>
                        </button>
                    </div>
                </div>

                <!-- Recent Inventory Trees -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            üìù Piedilista Recente
                        </h2>
                        <span id="inventoryTreeCount" class="stat-value" style="font-size: 1rem;">0 piante</span>
                    </div>
                    
                    <div class="recent-entries" id="recentInventoryTrees">
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            Nessuna pianta del piedilista rilevata ancora.<br>
                            Seleziona una specie e inizia il conteggio!
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Tab -->
        <div id="results" class="tab-content">
            <!-- Project Management Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        üìÇ Gestione Progetti
                    </h2>
                    <div id="projectInfo" style="font-size: 0.9rem; color: var(--text-secondary);">
                        Nessun progetto caricato
                    </div>
                </div>

                <div class="actions">
                    <button class="btn btn-primary" onclick="createNewProject()">
                        ‚ûï Nuovo Progetto
                    </button>
                    
                    <button class="btn btn-secondary" onclick="exportCurrentProject()">
                        üìÑ Esporta Progetto
                    </button>
                    
                    <button class="btn btn-secondary" onclick="importProject()">
                        üì• Importa Progetto
                    </button>
                    
                    <button class="btn btn-secondary" onclick="deleteCurrentProject()" style="background: var(--error); color: white;">
                        üóëÔ∏è Elimina Progetto
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        üìà Risultati e Statistiche
                    </h2>
                </div>

                <!-- Summary Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalAreaHa">30.0 ha</div>
                        <div class="stat-label">Area Totale</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="treesPerHaResult">0</div>
                        <div class="stat-label">Piante/Ha</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="basalAreaHa">0.0 m¬≤/ha</div>
                        <div class="stat-label">Area Basim./Ha</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="volumeHa">0.0 m¬≥/ha</div>
                        <div class="stat-label">Volume/Ha</div>
                    </div>
                </div>

                <!-- Species Analysis -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            üå≤ Analisi per Specie
                        </h2>
                    </div>
                    
                    <div id="speciesAnalysis">
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            Nessun dato da analizzare ancora
                        </div>
                    </div>
                </div>

                <!-- Height Analysis -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            üìè Analisi Altezze Medie
                        </h2>
                    </div>
                    
                    <div id="heightAnalysis">
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            Nessuna area di saggio rilevata ancora
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="actions">
                    <button class="btn btn-secondary" onclick="exportAllData()">
                        üìÑ Esporta CSV Completo
                    </button>
                    
                    <button class="btn btn-secondary" onclick="generateReport()">
                        üìä Genera Report Completo
                    </button>
                    
                    <button id="saveBtn" class="btn btn-primary" onclick="saveToGoogleSheetsOptional()" style="background: var(--secondary); color: var(--text-primary); border: 1px solid var(--border);">
                        <span id="saveIcon">‚òÅÔ∏è</span>
                        <span id="saveText">Sync con Google Sheets (Opzionale)</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notifications"></div>

    <!-- JavaScript -->
    <script src="js/database.js"></script>
    <script src="js/projectManager.js"></script>
    <script src="js/app.js"></script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('üîß Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.log('‚ùå Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>